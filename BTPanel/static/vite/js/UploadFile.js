import{_ as e}from"./index.js?v=1760428868419";import{n as l,_ as a,co as t,m as s,t as i,p as o}from"./page_layout.js?v=1760428868419";import{a as n}from"./public.js?v=1760428868419";import{u,g as d}from"./index39.js?v=1760428868419";import{k as c,P as p,i as f,r,W as m,a2 as v,V as h,a3 as y,S as g,a4 as x,U as _,ak as w,c as k,R as b,j as M,an as C,F as j,O as S,I as $,n as z}from"./vue.js?v=1760428868419";import{dg as P,di as F,aC as U}from"./naive.js?v=1760428868419";import"./common.js?v=1760428868419";import"./__commonjsHelpers__.js?v=1760428868419";import"./soft2.js?v=1760428868419";import"./soft.js?v=1760428868419";import"./site.js?v=1760428868419";import"./file2.js?v=1760428868419";import"./index.vue_vue_type_script_setup_true_lang7.js?v=1760428868419";const I={class:"p-20px"},N={class:"flex items-center gap-10px mb-16px"},L={class:"flex-1 w-0 text-14px"},R=c({__name:"FileConflict",props:{fileList:{}},emits:["step","confirm"],setup(t,{emit:s}){const{t:i}=p(),o=s,n=f("fileStore"),{fileConflictShow:u}=n,d=r([{title:i("file.uploadModal.conflictFileName"),key:"filename",ellipsis:{tooltip:!0}},{title:i("file.uploadModal.conflictFileDifference"),key:"difference",width:200,render:e=>m("span",null,[l(e.size)+"--\x3e"+l(e.size)])}]),c=()=>{o("step")},k=()=>{o("confirm")};return(l,t)=>{const s=a,o=P,n=e;return h(),v(n,{show:_(u),"onUpdate:show":t[0]||(t[0]=e=>w(u)?u.value=e:null),title:_(i)("file.uploadModal.conflictTitle"),width:600,footer:!0,"confirm-text":_(i)("file.uploadModal.conflictOverwrite"),"cancel-text":_(i)("file.uploadModal.conflictSkip"),onCancel:c,onConfirm:k},{default:y(()=>[g("div",I,[g("div",N,[m(s,{name:"base-warning",class:"text-warning text-30px"}),g("div",L,x(_(i)("file.uploadModal.conflictMessage")),1)]),m(o,{"max-height":400,columns:_(d),data:l.fileList},null,8,["columns","data"])])]),_:1},8,["show","title","confirm-text","cancel-text"])}}}),A={class:"p-20px"},B={key:0,class:"flex justify-between items-center mb-16px"},E={key:1,class:"status-tools-wrapper mb-16px"},H={class:"status-tools"},O={class:"tools-item"},T={class:"item-label"},D={class:"value"},V={class:"tools-item"},W={class:"item-label"},q={class:"value"},G={class:"tools-item"},J={class:"item-label"},K={class:"value"},Q={key:0,class:"tools-item"},X={class:"item-label"},Y={class:"value"},Z={key:2,class:"files-list-wrapper"},ee={class:"files-tit"},le={class:"name"},ae={class:"size"},te={class:"status"},se={class:"operation"},ie={class:"name"},oe={class:"size"},ne={class:"status"},ue={class:"operation"},de={key:3,class:"file-empty"},ce={class:"flex justify-end gap-16px mt-20px"},pe=o(c({__name:"UploadFile",setup(o,{expose:c}){const P=f("fileStore"),{uploadFileList:I,uploadShow:N}=P,{currentPath:L,uploadComplete:pe,startUpload:fe,fileConflictShow:re}=P,me=r([]),{t:ve}=p(),he=r({total:0,done:0,time:0,speed:0,num:0}),ye=r(),ge=r(),xe=r([{key:"file",label:k(()=>ve("file.uploadFile"))},{key:"dir",label:k(()=>ve("file.uploadFolder"))}]);function _e(e){"file"==e?we():ge.value.click()}function we(){ye.value.click()}function ke(e){const l=e.target.files;if(l){let e=!1;for(let a=0;a<l.length;a++){-1==I.value.findIndex(e=>e.file.name==l[a].name)?I.value.push({relativePath:"",file:l[a],status:0,name:l[a].name,size:l[a].size,progress:0}):e=!0}e&&s.error(ve("file.uploadModal.fileAlreadyExists"),{close:!0})}ye.value.value=""}function be(e){const l=e.target.files;if(l){let e=!1;for(let a=0;a<l.length;a++){let t=l[a].webkitRelativePath.split("/");t.pop();-1==I.value.findIndex(e=>e.file.name==l[a].name)?I.value.push({relativePath:t.join("/"),file:l[a],name:l[a].name,status:0,size:l[a].size,progress:0}):e=!0}e&&s.error(ve("file.uploadModal.fileAlreadyExists"),{close:!0})}ge.value.value=""}function Me(){I.value=[]}function Ce(e){switch(e){case 0:return ve("file.uploadModal.statusNotStarted");case 1:return ve("file.uploadModal.statusUploading");case 2:return ve("file.uploadModal.statusCompleted");case 3:return ve("file.uploadModal.statusFailed")}}async function je(){const e=I.value.map(e=>e.relativePath?L.value+"/"+e.relativePath+"/"+e.file.name:L.value+"/"+e.file.name),l=await async function(e){return(await i.post("/files?action=upload_files_exists",{files:e.join("\n")})).message.filter(e=>e.exists)}(e);0==l.length?await ze():(console.log(I),me.value=l,re.value=!0)}function Se(){re.value=!1,async function(){I.value=I.value.filter(e=>-1==me.value.findIndex(l=>l.filename.includes(e.file.name))),I.value.length>0?await ze():Pe()}()}function $e(){re.value=!1,ze()}async function ze(){he.value.total=I.value.reduce((e,l)=>e+l.file.size,0),fe.value=!0;const e=function(){let e=0;const l=setInterval(()=>{e++,he.value.time=e,he.value.speed=he.value.done/he.value.time,console.log(he.value)},1e3);return l}();for(let a=0;a<I.value.length;a++){I.value[a].status=1;try{await u(I.value[a].file,"/files?action=upload",1048576,L.value+"/"+I.value[a].relativePath,e=>{I.value[a].progress=e},e=>{isNaN(Number(e.message))||(he.value.done=Number(e.message))}),I.value[a].status=2,he.value.num+=1}catch(l){I.value[a].status=3,console.warn(l)}}clearInterval(e),pe.value=!0,d(P),z(()=>I.value=[]),console.log("上传结束")}function Pe(){pe.value=!1,fe.value=!1,he.value={total:0,done:0,speed:0,num:0,time:0},I.value=[]}c({open(){N.value=!0},close(){N.value=!1}});const Fe=()=>{if(!pe.value&&I.value.length>0)return n({title:ve("file.uploadModal.cancelUpload"),content:ve("file.uploadModal.cancelUploadConfirm"),onConfirm(){N.value=!1}}),!1},Ue=()=>{Pe()};return(s,i)=>{const o=a,n=U,u=F,d=t,c=e;return h(),b(j,null,[m(c,{show:_(N),"onUpdate:show":i[0]||(i[0]=e=>w(N)?N.value=e:null),title:s.$t("file.uploadModal.title"),width:720,onPublicClose:Fe,onAfterLeave:Ue},{default:y(()=>[g("div",A,[g("input",{type:"file",style:{display:"none"},ref_key:"fileInputRef",ref:ye,onChange:ke,multiple:""},null,544),g("input",{type:"file",style:{display:"none"},ref_key:"dirInputRef",ref:ge,onChange:be,webkitdirectory:"",directory:"",multiple:""},null,544),_(fe)&&0!=_(I).length?(h(),b("div",E,[g("div",H,[g("div",O,[g("div",T,x(s.$t("file.uploadModal.uploadSize")),1),g("div",D,x("".concat(_(l)(_(he).done),"/").concat(_(l)(_(he).total))),1)]),g("div",V,[g("div",W,x(s.$t("file.uploadModal.averageSpeed")),1),g("div",q,x(_(l)(_(he).speed))+"/s",1)]),g("div",G,[g("div",J,x(s.$t("file.uploadModal.uploadSuccess")),1),g("div",K,x(_(I).length)+" / "+x(_(he).num),1)]),_(pe)?(h(),b("div",Q,[g("div",X,x(s.$t("file.uploadModal.totalTime")),1),g("div",Y,x(_(he).time)+"s",1)])):C("",!0)])])):(h(),b("div",B,[m(u,{options:_(xe),trigger:"hover",onSelect:_e},{default:y(()=>[m(n,{type:"primary","icon-placement":"right",onClick:we},{icon:y(()=>[m(o,{name:"base-arrow-bottom",size:"14"})]),default:y(()=>[M(x(s.$t("file.uploadFile"))+" ",1)]),_:1})]),_:1},8,["options"]),m(n,{disabled:0==_(I).length,onClick:Me},{default:y(()=>[M(x(s.$t("Public.Btn.Clear")),1)]),_:1},8,["disabled"])])),_(I).length>0?(h(),b("div",Z,[g("div",ee,[g("span",le,x(s.$t("file.uploadModal.fileName")),1),g("span",ae,x(s.$t("file.uploadModal.fileSize")),1),g("span",te,x(s.$t("file.uploadModal.uploadStatus")),1),g("span",se,x(s.$t("file.uploadModal.operation")),1)]),m(d,{style:{height:"350px"}},{default:y(()=>[(h(!0),b(j,null,S(_(I),(e,a)=>(h(),b("div",{class:"list-item",key:a},[g("span",ie,x(e.relativePath?"".concat(e.relativePath,"/").concat(e.file.name):e.file.name),1),g("span",oe,x(_(l)(e.file.size)),1),g("span",ne,x(Ce(e.status)),1),g("span",ue,[2!==e.status?(h(),v(n,{key:0,text:"",type:"primary",onClick:e=>function(e){I.value.splice(e,1)}(a)},{default:y(()=>[M(x(s.$t("Public.Btn.Cancel")),1)]),_:2},1032,["onClick"])):C("",!0)]),g("div",{class:"progress",style:$({width:"".concat(e.progress,"%")})},null,4)]))),128))]),_:1})])):(h(),b("div",de,[g("span",null,x(s.$t("file.uploadModal.dragFilesHere")),1)])),g("div",ce,[_(fe)?(h(),v(n,{key:0,type:"primary",disabled:0==_(I).length,onClick:je},{default:y(()=>[M(x(s.$t("file.uploadModal.continueUpload")),1)]),_:1},8,["disabled"])):(h(),v(n,{key:1,type:"primary",disabled:0==_(I).length,onClick:je},{default:y(()=>[M(x(s.$t("file.uploadModal.confirmUpload")),1)]),_:1},8,["disabled"]))])])]),_:1},8,["show","title"]),m(R,{"file-list":_(me),onStep:Se,onConfirm:$e},null,8,["file-list"])],64)}}}),[["__scopeId","data-v-d4a59164"]]);export{pe as default};
